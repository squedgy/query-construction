
plugins {
    id "net.ltgt.apt"
}

repositories {
    jcenter()
}

dependencies {


    testImplementation group: 'junit', name:'junit', version: '4.12'
    testImplementation group: 'org.jdbi', name: 'jdbi3-core', version: '3.6.0'
    testImplementation group: 'postgresql', name: 'postgresql', version: '9.1-901-1.jdbc4'
    testImplementation group: 'fun.mike', name: 'io-support-alpha', version: '0.0.13'
    testImplementation group: 'fun.mike', name: 'record-alpha', version: '0.0.38'
    testImplementation group: 'org.slf4j', name: 'slf4j-simple', version: '1.7.26'


//    annotationProcessor fileTree(dir: 'libs', include: ['*.jar'])

    api project(':annotations')
    annotationProcessor project(':processing')
    implementation group: 'org.slf4j', name: 'slf4j-api', version: '1.7.26'


}

tasks.test {
    testLogging {
        showStandardStreams = true
    }
}

logging.captureStandardError(LogLevel.ERROR)
logging.captureStandardOutput(LogLevel.ERROR)

tasks.create('initTestDb') {
    doLast {
        exec {
            logger.lifecycle('creating db')
            commandLine 'createdb', '-e', 'test-db'
        }
        exec {
            logger.lifecycle('creating/populating db')
            commandLine 'psql', '-f', 'sql-scripts/create.sql', 'test-db'
        }
        exec {
            logger.lifecycle("Database information:")
            commandLine 'psql', '-c', '\\dt', 'test-db'
        }
        logger.lifecycle(fileTree(dir: 'libs').asPath)
        fileTree(dir: 'libs').files.forEach{ file ->
            logger.lifecycle(file.name)
        }
    }
}

tasks.create('postTests', Exec) {
    commandLine 'dropdb', '-e', 'test-db'

    doLast{
        logger.lifecycle('dropping database')
    }
}

tasks.test.dependsOn(tasks.getByName('initTestDb'))
tasks.test.finalizedBy(tasks.getByName('postTests'))
//tasks.compileJava.dependsOn(':processing:jar')
